import re
import base64


def string_analysis(file_path):
    values = []
    details = {}
    results = []

    with open(file_path, 'rb') as f:
        content = f.read()
        
    strings = re.findall(b'[ -~]{4,}', content)
    
    for string in strings:
        string = string.decode('utf-8', 'ignore')
        
        # URLs
        urls = re.findall(r'https?://[^\s<>"]+|www\.[^\s<>"]+', string) 
        values.extend(urls)
        details["source"] = "Suspicious URL"
        details["danger"] = "Could communicate with malicious server"
            

        # IP addresses
        ip_addresses = re.findall(r'\b(?:\d{1,3}\.){3}\d{1,3}\b|\b(?:[a-fA-F0-9]{1,4}:){7}[a-fA-F0-9]{1,4}\b', string)
        values.extend(ip_addresses)

        # Registry keys
        registry_keys = re.findall(r'HKEY_[A-Za-z0-9_/\\]+', string)
        values.extend(registry_keys)

        # C2 servers
        c2_servers = re.findall(r'https?://[^\s<>"]+|www\.[^\s<>"]+|\b(?:\d{1,3}\.){3}\d{1,3}\b', string)
        values.extend(c2_servers)

        # Base64-encode Strings
        base64_strings = re.findall(r'[A-Za-z0-9+/]+={0,2}', string)
        for base64_str in base64_strings:
            try:
                decoded_str = base64.b64decode(base64_str).decode('utf-8', 'ignore')
                values.append(decoded_str)
            except Exception:
                pass
        details["source"] = "Base64 encoded string"
        details["danger"] = "Could hide malicious payload"

        # Hex-encoded Strings
        hex_strings = re.findall(r'([0-9a-fA-F]{2}){2,}', string)
        for hex_str in hex_strings:
            try:
                decoded_str = bytes.fromhex(hex_str).decode('utf-8', 'ignore')
                values.append(decoded_str)
            except ValueError:
                pass
        details["source"] = "Hex encoded string"
        details["danger"] = "Could hide malicious payload"

        # Email addresses
        emails = re.findall(r'[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+', string)
        values.extend(emails)
        
        # File paths
        file_paths = re.findall(r'[A-Za-z]:(\\[^:"><|?*\x00-\xFF]*)+', string)
        values.extend(file_paths)
        
        # Other regex checks
        keywords = re.findall(r'password|login|apikey|key|secret|credential|database', string) 
        values.extend(keywords)
        details["source"] = "Sensitive keyword"
        details["danger"] = "May expose authentication details"

    if details:
            details["string"] = values
            results.append(details)

    for result in results:
        print(f"Suspicious string found: {result['string']}") 
        print(f"\t- Source: {result['source']}")
        print(f"\t- Potential danger: {result['danger']}")

    print("\nUseful string values: ",list(set(values)))    
    return list(set(values))


